<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; }
    .dashboard { background: white; padding: 20px; border-radius: 8px; max-width: 1000px; margin: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #007bff; color: white; }
    button { padding: 10px 15px; margin-top: 10px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer; }
    .download-btn { background: #28a745; color: white; }
    .download-btn:hover { background: #218838; }
    .logout-btn { background: #dc3545; color: white; float: right; }
    .logout-btn:hover { background: #b52a37; }
  </style>
</head>
<body>
  <div class="dashboard">
    <h2>Admin Dashboard</h2>
    <button class="logout-btn" onclick="logout()"> Logout ðŸšª </button>

    <table id="userTable">
      <thead>
        <tr>
          <th>Name / Age</th>
          <th>Email</th>
          <th>Score</th>
          <th>Total</th>
          <th>Submitted At</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="download-btn" onclick="downloadCSV()">â¬‡ Download Results (CSV)</button>
  </div>

<script>
  /* ================= CONFIG: published CSV link ================= */
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYoM-aMGEb-5y2ePc3FAfGQ6EzZ-7-NQQSKEC6bsBwhQ9UTpmH5t5A_I8mmObVWrDG2uApWJm_GM3b/pub?output=csv";

  let SHEET_ROWS = [];

  function parseCSV(text){
    const rows = [];
    let cur = [], val = "", inQuotes = false;
    function pushVal(){ cur.push(val); val = ""; }
    function pushRow(){ rows.push(cur); cur = []; }
    for (let i=0;i<text.length;i++){
      const c = text[i], n = text[i+1];
      if (inQuotes){
        if (c === '"' && n === '"'){ val += '"'; i++; }
        else if (c === '"'){ inQuotes = false; }
        else { val += c; }
      } else {
        if (c === '"'){ inQuotes = true; }
        else if (c === ','){ pushVal(); }
        else if (c === '\n'){ pushVal(); pushRow(); }
        else if (c === '\r'){ }
        else { val += c; }
      }
    }
    if (val.length || cur.length){ pushVal(); pushRow(); }
    return rows.filter(r => r.length && r.some(cell => String(cell).trim() !== ""));
  }

  function rowsToObjects(rows){
    const header = rows[0];
    return rows.slice(1).map(r => {
      const o = {};
      header.forEach((h,i) => o[h] = r[i] ?? "");
      return o;
    });
  }

  function renderTable(rows){
    const tbody = document.querySelector("#userTable tbody");
    tbody.innerHTML = "";

    const toNum = x => {
      const n = Number(String(x).trim());
      return Number.isFinite(n) ? n : NaN;
    };

    const sorted = rows.slice().sort((a,b)=>{
      const as = toNum(a["score"]), bs = toNum(b["score"]);
      if (Number.isFinite(as) && Number.isFinite(bs)) return bs - as;
      return 0;
    });

    for (const r of sorted){
      const rowHtml = `<tr>
        <td>${r["name"] || 'â€”'} / ${r["age"] || 'â€”'}</td>
        <td>${r["email"] || 'â€”'}</td>
        <td>${r["score"] || 'â€”'}</td>
        <td>${r["total"] || 'â€”'}</td>
        <td>${r["submittedAt"] || 'â€”'}</td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend", rowHtml);
    }
  }

  function downloadCSV(){
    if (!SHEET_ROWS.length) return;
    const header = ["Name","Age","Email","Score","Total","SubmittedAt"];
    const lines = [header.join(",")];
    for (const r of SHEET_ROWS){
      const line = [
        r["name"] ?? "",
        r["age"] ?? "",
        r["email"] ?? "",
        r["score"] ?? "",
        r["total"] ?? "",
        r["submittedAt"] ?? ""
      ].join(",");
      lines.push(line);
    }
    const csv = lines.join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "results.csv";
    link.click();
  }

  async function loadSheet(){
    try{
      const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
      const text = await res.text();
      const rows = parseCSV(text);
      if (!rows.length){ console.error("No data in CSV."); return; }
      SHEET_ROWS = rowsToObjects(rows);
      renderTable(SHEET_ROWS);
    } catch(err){
      console.error("Failed to fetch sheet:", err);
    }
  }

  window.onload = loadSheet;
  window.downloadCSV = downloadCSV;
  function logout(){ window.location.href = "admin-logout.html"; }
  window.logout = logout;
</script>

</body>
</html>

